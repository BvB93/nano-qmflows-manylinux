name: Build MacOS dependencies

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build MacOS dependencies
    runs-on: macos-10.15
    env:
      MACOSX_DEPLOYMENT_TARGET: "10.14"
      HIGHFIVE_VERSION: "2.3.1"
      BOOST_VERSION: "1.78.0"
      EIGEN_VERSION: "3.4.0"
      HDF5_VERSION: "1.12.1"
      LIBINT_VERSION: "2.6.0"

    steps:
    - uses: actions/checkout@v3


    - name: Set up Python
      uses: actions/setup-python@v3

    - name: Python info
      run: |
        which python
        python --version

    - name: Installed packages
      run: pip list

    - name: Create output directories
      run: |
        mkdir -p output/lib
        mkdir -p output/bin
        mkdir -p output/include

    - name: Install Automake
      run: |
        brew update
        brew install automake

    - name: Install HighFive
      run: bash tools/install_highfive.sh $HIGHFIVE_VERSION $PWD/output

    - name: Install Boost
      run: bash tools/install_boost.sh $BOOST_VERSION $PWD/output

    - name: Install Eigen
      run: bash tools/install_eigen.sh $EIGEN_VERSION $PWD/output

    - name: Install Libint
      run: |
        cp -r output/include/* /usr/local/include/
        bash tools/install_libint.sh $LIBINT_VERSION $PWD/output 2

    - name: Install HDF5
      run: bash tools/install_hdf5.sh $HDF5_VERSION $PWD/output 2

    - name: Commit output
      run: |
        git switch main

        rm macos/README.rst
        rm macos/macos_deps.tar.gz
        tar -czvf macos/macos_deps.tar.gz output
        python tools/construct_readme.py macos/README.rst

        COMMIT_MSG=${cat macos/README.rst}
        git add macos/README.rst
        git add macos/macos_deps.tar.gz
        git commit -m "$COMMIT_MSG"
        git push
